package ru.zaikin.mvvmproject.repository

import android.content.Context
import androidx.room.Database
import androidx.room.Room
import androidx.room.RoomDatabase
import androidx.sqlite.db.SupportSQLiteDatabase
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import ru.zaikin.mvvmproject.dao.GenreDao
import ru.zaikin.mvvmproject.dao.MovieDao
import ru.zaikin.mvvmproject.model.Genre
import ru.zaikin.mvvmproject.model.Movie

@Database(entities = [Movie::class, Genre::class], version = 1)
abstract class MovieDatabase : RoomDatabase() {

    abstract fun getMovieDao(): MovieDao
    abstract fun getGenreDao(): GenreDao

    companion object {
        @Volatile
        private var INSTANCE: MovieDatabase? = null

        fun getInstance(context: Context): MovieDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    MovieDatabase::class.java,
                    "movie_database"
                )
                    .fallbackToDestructiveMigration()
                    .addCallback(MovieDatabaseCallback())
                    .build()
                INSTANCE = instance
                instance
            }
        }
    }

    private class MovieDatabaseCallback : RoomDatabase.Callback() {
        override fun onCreate(db: SupportSQLiteDatabase) {
            super.onCreate(db)
            INSTANCE?.let { database ->
                CoroutineScope(Dispatchers.IO).launch {
                    populateDatabase(database.getGenreDao(), database.getMovieDao())
                }
            }
        }

        private suspend fun populateDatabase(genreDao: GenreDao, movieDao: MovieDao) {
            val genres = listOf(
                Genre(genre = "Драма"),
                Genre(genre = "Фантастика"),
                Genre(genre = "Комедия"),
                Genre(genre = "Ужасы")
            )
            genres.forEach { genreDao.insert(it) }

            val movies = listOf(
                // Драма
                Movie(
                    name = "Зеленая миля",
                    movieDescription = "Фильм рассказывает историю заключенного, обладающего мистическим даром исцелять людей. " +
                            "События разворачиваются в тюрьме в 1930-х годах. " +
                            "Главный герой сталкивается с несправедливостью системы и моральными дилеммами. " +
                            "Повествование переплетается с человеческими судьбами и трагедиями. " +
                            "Фильм оставляет сильное эмоциональное впечатление и заставляет задуматься о жизни и смерти.",
                    genreId = 1
                ),
                Movie(
                    name = "Титаник",
                    movieDescription = "Эпическая история любви на фоне катастрофы легендарного лайнера. " +
                            "Главные герои из разных социальных слоев влюбляются друг в друга. " +
                            "Сюжет поднимает темы трагедии, преданности и выбора между долгом и сердцем. " +
                            "Фильм полон визуальных эффектов, воссоздающих историческую эпоху. " +
                            "Оставляет сильное эмоциональное впечатление на зрителя, заставляя переживать за персонажей.",
                    genreId = 1
                ),
                Movie(
                    name = "Форрест Гамп",
                    movieDescription = "История человека с ограниченными интеллектуальными возможностями, который переживает необычные жизненные события. " +
                            "Фильм охватывает десятилетия американской истории. " +
                            "Главный герой становится участником ключевых событий и меняет жизни окружающих. " +
                            "Трогательная и вдохновляющая драма о любви, дружбе и судьбе. " +
                            "В фильме переплетаются юмор, трагедия и философия жизни.",
                    genreId = 1
                ),

                // Фантастика
                Movie(
                    name = "Интерстеллар",
                    movieDescription = "Фильм рассказывает о путешествии группы астронавтов через червоточину в поисках новой планеты для человечества. " +
                            "Сюжет исследует темы времени, гравитации и человеческой жертвы. " +
                            "Главный герой оставляет семью, чтобы спасти будущее человечества. " +
                            "Фильм сочетает научную точность с эмоциональной драмой. " +
                            "Визуальные эффекты и музыка создают невероятное ощущение космического масштаба.",
                    genreId = 2
                ),
                Movie(
                    name = "Начало",
                    movieDescription = "Сюжет фильма вращается вокруг группы специалистов, которые проникают в сны людей для извлечения или внедрения идей. " +
                            "Главный герой борется с личными травмами и потерей семьи. " +
                            "Фильм исследует границы реальности и иллюзии. " +
                            "В фильме сложная структура повествования с множественными уровнями сна. " +
                            "Каждая сцена наполнена напряжением и философскими подтекстами о сознании и памяти.",
                    genreId = 2
                ),
                Movie(
                    name = "Матрица",
                    movieDescription = "История Нео, который обнаруживает, что мир, в котором он живет, — всего лишь симуляция. " +
                            "Он присоединяется к группе повстанцев, чтобы освободить человечество. " +
                            "Фильм поднимает вопросы свободы воли и контроля технологий. " +
                            "Экшен-сцены, визуальные эффекты и философские размышления делают фильм культовым. " +
                            "Сюжет сочетает научную фантастику с напряженной драмой о человеческой природе.",
                    genreId = 2
                ),
                Movie(
                    name = "Стражи Галактики",
                    movieDescription = "Команда разношерстных героев объединяется, чтобы защитить галактику от злодеев. " +
                            "Фильм сочетает юмор, приключения и космический экшен. " +
                            "Персонажи учатся работать вместе, несмотря на личные разногласия. " +
                            "История наполнена эмоциональными моментами, неожиданными поворотами и визуальными эффектами. " +
                            "Поднимаются темы дружбы, самопожертвования и поиска своего места в мире.",
                    genreId = 2
                ),

                // Комедия
                Movie(
                    name = "Шрэк",
                    movieDescription = "Мультфильм о зеленом огре, который живет в одиночестве в болоте. " +
                            "Его жизнь меняется, когда в его дом начинают приходить сказочные персонажи. " +
                            "Фильм полон юмора, забавных диалогов и неожиданных ситуаций. " +
                            "Главный герой учится дружбе, любви и смелости. " +
                            "Яркая анимация и остроумные шутки делают мультфильм любимым для детей и взрослых.",
                    genreId = 3
                ),
                Movie(
                    name = "День сурка",
                    movieDescription = "История человека, который застрял во временной петле, переживая один и тот же день снова и снова. " +
                            "Главный герой сначала раздражен, но затем начинает меняться и развиваться. " +
                            "Фильм исследует темы самопознания, любви и ценности каждого момента. " +
                            "Комедийные ситуации переплетаются с глубокими философскими размышлениями. " +
                            "Зрителя ждет увлекательное сочетание юмора и морального посыла.",
                    genreId = 3
                ),
                Movie(
                    name = "Тупой и ещё тупее",
                    movieDescription = "Комедия о двух друзьях, которые совершают нелепые и смешные поступки во время путешествия. " +
                            "Фильм наполнен абсурдными ситуациями, каламбурами и визуальными шутками. " +
                            "Главные герои постоянно попадают в комичные передряги. " +
                            "История легкая, веселая и идеально подходит для поднятия настроения. " +
                            "Фильм стал культовым среди поклонников комедий 90-х.",
                    genreId = 3
                ),

                // Ужасы
                Movie(
                    name = "Сияние",
                    movieDescription = "История писателя, который вместе с семьей приезжает в изолированный отель на зиму. " +
                            "Со временем он теряет рассудок, а его сын сталкивается с сверхъестественными явлениями. " +
                            "Фильм создает напряженную атмосферу ужаса и психологической драмы. " +
                            "Темы одиночества, безумия и сверхъестественного переплетаются между собой. " +
                            "Культовый хоррор, оставляющий зрителя в состоянии тревоги долгое время после просмотра.",
                    genreId = 4
                ),
                Movie(
                    name = "Заклятие",
                    movieDescription = "Сюжет рассказывает о семье, которая сталкивается с паранормальной активностью в новом доме. " +
                            "Исследователи паранормальных явлений помогают разгадать тайну и спасти семью. " +
                            "Фильм сочетает элементы мистики, ужаса и психологической напряженности. " +
                            "Пугающие сцены и неожиданные повороты держат зрителя в постоянном напряжении. " +
                            "Идеально подходит для любителей страшных историй с продуманным сюжетом.",
                    genreId = 4
                ),
                Movie(
                    name = "Пила",
                    movieDescription = "История двух людей, оказавшихся в ловушке смертельной игры маньяка. " +
                            "Фильм поднимает вопросы морали, выбора и человеческой природы. " +
                            "Напряженные сцены, неожиданные повороты и мрачная атмосфера создают сильное впечатление. " +
                            "Главные герои сталкиваются с моральными и физическими испытаниями, пытаясь выжить. " +
                            "Фильм известен своей жесткой тематикой и запоминающимися сценами.",
                    genreId = 4
                )
            )
            movies.forEach { movieDao.insert(it) }
        }

    }
}
